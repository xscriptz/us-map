<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8" /><base>
    <style>
    .stations, .stations svg {
  position: absolute;
}

.stations svg {
  width: 60px;
  height: 60px;
  padding-right: 100px;
  font: 10px sans-serif;
}

.stations circle {
  fill: brown;
  stroke: black;
  stroke-width: 1.5px;
}
    </style>
    <title>Google Maps JavaScript API v3 Example: Limit Panning</title>
    <script type="text/javascript" src="http://maps.google.com/maps/api/js?sensor=false"></script>
    <script type="text/javascript" src="d3.v3.js"></script>
    <script type="text/javascript" src="smallData.js"></script>
    <script type="text/javascript" src="visualizationOnMap.js"></script>
</head>

<body>
    <div id="map" style="width: 800px; height: 500px;"></div>

    <script type="text/javascript">
       // d3.csv("2010CensusPopulationData.csv", function(error, csvDataObj) {
            //console.log(zipCodeObj);
            var minZoomLevel = 4;

            var map = new google.maps.Map(document.getElementById('map'), {
                zoom: minZoomLevel,
                center: new google.maps.LatLng(38.50, -90.50),
                mapTypeId: google.maps.MapTypeId.ROADMAP
            });

            // Bounds for North America
            var allowedBounds = new google.maps.LatLngBounds(
                new google.maps.LatLng(28.70, -127.50),
                new google.maps.LatLng(48.85, -55.90));

            // Listen for the dragend event
            google.maps.event.addListener(map, 'dragend', function() {
                if (allowedBounds.contains(map.getCenter())) return;

                // Out of bounds - Move the map back within the bounds

                var c = map.getCenter(),
                    x = c.lng(),
                    y = c.lat(),
                    maxX = allowedBounds.getNorthEast().lng(),
                    maxY = allowedBounds.getNorthEast().lat(),
                    minX = allowedBounds.getSouthWest().lng(),
                    minY = allowedBounds.getSouthWest().lat();

                if (x < minX) x = minX;
                if (x > maxX) x = maxX;
                if (y < minY) y = minY;
                if (y > maxY) y = maxY;

                map.setCenter(new google.maps.LatLng(y, x));
            });

            // Limit the zoom level
            google.maps.event.addListener(map, 'zoom_changed', function() {
                if (map.getZoom() < minZoomLevel) map.setZoom(minZoomLevel);
            });
            google.maps.event.addListener(map, 'bounds_changed', function() {
                var bounds = map.getBounds();
                var ne = bounds.getNorthEast(); // LatLng of the north-east corner
                var sw = bounds.getSouthWest(); // LatLng of the south-west corder
                var nw = new google.maps.LatLng(ne.lat(), sw.lng());
                var se = new google.maps.LatLng(sw.lat(), ne.lng());
                var zipCodesArray = [];
                //console.log("North East: " + ne + "  " + "South West: " + sw + "North West: " + nw + "South East: " + se);
                for (var i = 0; i < finalDataArray.length; i++) {
                    if ((finalDataArray[i].Latitude >= sw.lat()) && (finalDataArray[i].Latitude <= nw.lat()) && (finalDataArray[i].Longitude >= nw.lng()) && (finalDataArray[i].Longitude <= ne.lng())) {
                        zipCodesArray.push(finalDataArray[i]);
                    }
                }
                var overlay = new google.maps.OverlayView();
                var w = 40;
                var h = 40;
                var r = h/2;
                var color = d3.scale.category20c();
             // Add the container when the overlay is added to the map.
                overlay.onAdd = function() {
                  var layer = d3.select(this.getPanes().overlayLayer).append("div")
                      .attr("class", "stations");
                for(var counter=0;counter<zipCodesArray.length;counter++){
                	drawPieChart(layer,zipCodesArray[counter]);
                	
                }
            }
                // Bind our overlay to the mapâ€¦
                overlay.setMap(map);
                function drawPieChart(layer,zipCodesArray){
                	var data = zipCodesArray.data;
                		//console.log(data);
                	overlay.draw = function() {
      				var projection = this.getProjection(),
          			padding = 10;
      				
      				var marker = layer.selectAll("svg")
      	          .data([data])
      	          .each(transform) // update existing markers
      	        .enter().append("svg")
      	           .each(transform) 
      	          .attr("class", "marker").attr("width", w)
      	          .attr("height", h).append("g")
      	          .attr("transform", "translate(" + r + "," + r + ")");
      				
      				var pie = d3.layout.pie().value(function(d,i){
      					return d.value;
      					//console.log(d.value);
      					});
      				var arc = d3.svg.arc().outerRadius(r);
      			// select paths, use arc generator to draw
      				var arcs = marker.selectAll("g.slice").data(pie).enter()
      				.append("svg:g").attr("class", "slice");
      				arcs.append("svg:path")
      				    .attr("fill", function(d, i){
      				        return color(i);
      				    })
      				    .attr("d", function (d) {
      				        // log the result of the arc generator to show how cool it is :)
      				        //console.log(d);
      				        return arc(d);
      				    });
      				 function transform(d,i) {
       					console.log(d);
      					 d = new google.maps.LatLng(zipCodesArray.Latitude, zipCodesArray.Longitude);
       			        d = projection.fromLatLngToDivPixel(d);
       			        return d3.select(this)
       			            .style("left", (d.x - padding) + "px")
       			            .style("top", (d.y - padding) + "px");
       			      }
                	}
                }
            });
            
    </script>
</body>

</html>